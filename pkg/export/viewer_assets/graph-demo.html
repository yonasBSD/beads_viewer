<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bv Dependency Graph</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #282a36;
            --bg-secondary: #44475a;
            --bg-tertiary: #21222c;
            --fg: #f8f8f2;
            --fg-muted: #6272a4;
            --purple: #bd93f9;
            --pink: #ff79c6;
            --cyan: #8be9fd;
            --green: #50fa7b;
            --orange: #ffb86c;
            --red: #ff5555;
            --yellow: #f1fa8c;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--fg);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        header {
            background: linear-gradient(to right, var(--bg-tertiary), var(--bg-secondary));
            padding: 0.75rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--purple);
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--purple);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        h1 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--fg);
        }

        h1 span { color: var(--purple); }

        .toolbar {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 0.25rem;
            padding: 0.25rem;
            background: var(--bg);
            border-radius: 8px;
        }

        button, select {
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }

        button {
            background: transparent;
            color: var(--fg-muted);
        }

        button:hover { background: var(--bg-secondary); color: var(--fg); }
        button.active { background: var(--purple); color: var(--bg); }

        select {
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--bg-secondary);
            padding-right: 1.5rem;
        }

        select:focus { outline: none; border-color: var(--purple); }

        .search-box {
            position: relative;
        }

        .search-box input {
            font-family: inherit;
            font-size: 0.75rem;
            padding: 0.5rem 0.75rem 0.5rem 2rem;
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--bg-secondary);
            border-radius: 6px;
            width: 200px;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--purple);
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.75rem;
        }

        /* Main content */
        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        #graph-container {
            flex: 1;
            position: relative;
        }

        /* Sidebar */
        #sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--purple);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--cyan);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: var(--bg);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--green);
        }

        .stat-value.warning { color: var(--orange); }
        .stat-value.danger { color: var(--red); }

        .stat-label {
            font-size: 0.625rem;
            color: var(--fg-muted);
            text-transform: uppercase;
            margin-top: 0.25rem;
        }

        /* Panel */
        .panel {
            margin-bottom: 1.5rem;
        }

        .panel-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--fg-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.75rem;
            color: var(--fg-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        /* Node Detail */
        #node-detail {
            background: var(--bg);
            border-radius: 8px;
            padding: 1rem;
            display: none;
        }

        #node-detail.visible { display: block; }

        .detail-header {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .detail-icon {
            font-size: 1.5rem;
        }

        .detail-title {
            flex: 1;
        }

        .detail-id {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--cyan);
        }

        .detail-name {
            font-size: 0.75rem;
            color: var(--fg);
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        .detail-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .badge {
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .badge-open { background: var(--green); color: var(--bg); }
        .badge-in_progress { background: var(--orange); color: var(--bg); }
        .badge-blocked { background: var(--red); color: var(--bg); }
        .badge-closed { background: var(--fg-muted); color: var(--fg); }

        .detail-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.625rem;
            color: var(--fg-muted);
        }

        .detail-metric span {
            color: var(--fg);
            font-weight: 500;
        }

        .detail-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.75rem;
        }

        .label-tag {
            font-size: 0.625rem;
            padding: 0.125rem 0.375rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
            color: var(--fg-muted);
        }

        .no-selection {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--fg-muted);
            font-size: 0.75rem;
        }

        /* Keyboard hints */
        .keyboard-hints {
            font-size: 0.625rem;
            color: var(--fg-muted);
        }

        .keyboard-hints kbd {
            display: inline-block;
            background: var(--bg);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            margin: 0 0.125rem;
            font-family: inherit;
        }

        /* Footer */
        footer {
            background: var(--bg-tertiary);
            padding: 0.5rem 1.5rem;
            font-size: 0.625rem;
            color: var(--fg-muted);
            display: flex;
            justify-content: space-between;
            border-top: 1px solid var(--bg-secondary);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--green);
        }

        .status-dot.warning { background: var(--orange); }

        /* Loading overlay */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .loading-overlay.hidden { display: none; }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--bg-secondary);
            border-top-color: var(--purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            margin-top: 1rem;
            color: var(--fg-muted);
        }

        /* View mode indicator */
        .view-mode-indicator {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--bg-secondary);
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.625rem;
            color: var(--fg-muted);
            z-index: 10;
        }

        .view-mode-indicator span { color: var(--purple); }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">üìä</div>
            <h1><span>bv</span> Dependency Graph</h1>
        </div>

        <div class="toolbar">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search issues...">
            </div>

            <div class="toolbar-group">
                <button id="btn-force" class="active" title="Force-directed layout (1)">Force</button>
                <button id="btn-hierarchy" title="Hierarchy layout (2)">Hierarchy</button>
                <button id="btn-radial" title="Radial layout (3)">Radial</button>
                <button id="btn-cluster" title="Cluster by status (4)">Cluster</button>
            </div>

            <div class="toolbar-group">
                <select id="filter-status">
                    <option value="">All Status</option>
                    <option value="open">Open</option>
                    <option value="in_progress">In Progress</option>
                    <option value="blocked">Blocked</option>
                </select>
            </div>

            <div class="toolbar-group">
                <button id="btn-critical" title="Highlight critical path (c)">Critical</button>
                <button id="btn-cycles" title="Highlight cycles (y)">Cycles</button>
            </div>

            <div class="toolbar-group">
                <button id="btn-fit" title="Fit all nodes">Fit</button>
                <button id="btn-reset" title="Reset view (r)">Reset</button>
            </div>
        </div>
    </header>

    <main>
        <div id="graph-container">
            <div class="loading-overlay" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Loading dependency graph...</div>
            </div>
            <div class="view-mode-indicator" id="view-mode">
                Mode: <span>Force</span>
            </div>
        </div>

        <div id="sidebar">
            <div class="sidebar-header">
                <h2>Graph Stats</h2>
            </div>
            <div class="sidebar-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="stat-nodes">0</div>
                        <div class="stat-label">Nodes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-edges">0</div>
                        <div class="stat-label">Edges</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="stat-actionable">0</div>
                        <div class="stat-label">Actionable</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value warning" id="stat-blocked">0</div>
                        <div class="stat-label">Blocked</div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Status Legend</div>
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #50fa7b;"></div>
                            <span>Open</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #ffb86c;"></div>
                            <span>In Progress</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #ff5555;"></div>
                            <span>Blocked</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-dot" style="background: #6272a4;"></div>
                            <span>Closed</span>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Selected Node</div>
                    <div id="node-detail">
                        <div class="detail-header">
                            <div class="detail-icon" id="detail-icon">üìã</div>
                            <div class="detail-title">
                                <div class="detail-id" id="detail-id">-</div>
                                <div class="detail-name" id="detail-name">-</div>
                            </div>
                        </div>
                        <div class="detail-badges">
                            <span class="badge" id="detail-status">-</span>
                            <span id="detail-priority" style="font-size: 0.75rem; font-weight: 600;">-</span>
                        </div>
                        <div class="detail-metrics">
                            <div class="detail-metric">Blockers: <span id="detail-blockers">-</span></div>
                            <div class="detail-metric">Dependents: <span id="detail-dependents">-</span></div>
                            <div class="detail-metric">PageRank: <span id="detail-pagerank">-</span></div>
                            <div class="detail-metric">Depth: <span id="detail-depth">-</span></div>
                        </div>
                        <div class="detail-labels" id="detail-labels"></div>
                    </div>
                    <div class="no-selection" id="no-selection">
                        Click a node to see details<br>
                        <kbd>Ctrl</kbd>+Click to show dependencies
                    </div>
                </div>

                <div class="panel">
                    <div class="panel-title">Keyboard Shortcuts</div>
                    <div class="keyboard-hints">
                        <kbd>1</kbd>-<kbd>4</kbd> View modes<br>
                        <kbd>c</kbd> Critical path<br>
                        <kbd>y</kbd> Cycles<br>
                        <kbd>r</kbd> Reset view<br>
                        <kbd>Esc</kbd> Clear selection<br>
                        <kbd>Ctrl</kbd>+<kbd>F</kbd> Search
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="status-indicator">
            <div class="status-dot" id="wasm-dot"></div>
            <span id="wasm-status">Checking WASM...</span>
        </div>
        <div>
            Node size = PageRank importance |
            <span id="cycle-count">No cycles detected</span>
        </div>
    </footer>

    <!-- Dependencies -->
    <script src="https://unpkg.com/force-graph@1.43.5/dist/force-graph.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- WASM module -->
    <script type="module">
        try {
            const wasm = await import('../../../bv-graph-wasm/pkg/bv_graph_wasm.js');
            window.bvGraphWasm = wasm;
        } catch (e) {
            console.log('WASM not available:', e.message);
        }
    </script>

    <!-- Main application -->
    <script type="module">
        import * as Graph from './graph.js';

        // Demo data generator
        function generateDemoData(nodeCount = 50) {
            const types = ['bug', 'feature', 'task', 'epic', 'chore'];
            const statuses = ['open', 'in_progress', 'blocked', 'closed'];
            const labels = ['frontend', 'backend', 'api', 'database', 'ui', 'performance', 'security'];

            const issues = [];
            const dependencies = [];

            for (let i = 1; i <= nodeCount; i++) {
                issues.push({
                    id: `bv-${i}`,
                    title: `Issue ${i}: ${types[i % types.length]} work item`,
                    status: statuses[Math.floor(Math.random() * 4)],
                    priority: Math.floor(Math.random() * 5),
                    type: types[i % types.length],
                    labels: [labels[i % labels.length], labels[(i + 3) % labels.length]].filter((_, idx) => Math.random() > 0.3)
                });
            }

            // Generate realistic dependency structure
            for (let i = 2; i <= nodeCount; i++) {
                // Each issue depends on 0-3 earlier issues
                const depCount = Math.floor(Math.random() * 3);
                for (let j = 0; j < depCount; j++) {
                    const target = Math.floor(Math.random() * (i - 1)) + 1;
                    dependencies.push({
                        issue_id: `bv-${i}`,
                        depends_on_id: `bv-${target}`,
                        type: 'blocks'
                    });
                }
            }

            // Add a few cycles for demonstration
            if (nodeCount > 20) {
                dependencies.push({ issue_id: 'bv-15', depends_on_id: 'bv-18', type: 'blocks' });
                dependencies.push({ issue_id: 'bv-18', depends_on_id: 'bv-15', type: 'blocks' });
            }

            return { issues, dependencies };
        }

        // Initialize
        async function init() {
            try {
                await Graph.initGraph('graph-container');

                // Load demo data
                const { issues, dependencies } = generateDemoData(60);
                const graphData = Graph.loadData(issues, dependencies);

                // Update stats
                updateStats(graphData);

                // Hide loading
                document.getElementById('loading').classList.add('hidden');

                // Setup UI
                setupUI();

                // Update WASM status
                updateWasmStatus();

            } catch (e) {
                console.error('Init failed:', e);
                document.getElementById('loading').innerHTML = `
                    <div style="color: #ff5555;">Failed to load: ${e.message}</div>
                `;
            }
        }

        function updateStats(graphData) {
            document.getElementById('stat-nodes').textContent = graphData.nodes.length;
            document.getElementById('stat-edges').textContent = graphData.links.length;
            document.getElementById('stat-actionable').textContent =
                graphData.nodes.filter(n => n.status === 'open' && n.blockerCount === 0).length;
            document.getElementById('stat-blocked').textContent =
                graphData.nodes.filter(n => n.status === 'blocked').length;
        }

        function updateWasmStatus() {
            const dot = document.getElementById('wasm-dot');
            const status = document.getElementById('wasm-status');

            if (Graph.isWasmReady()) {
                dot.style.background = '#50fa7b';
                status.textContent = 'WASM: Active';
            } else {
                dot.classList.add('warning');
                status.textContent = 'WASM: Fallback mode';
            }

            // Update cycle count
            const metrics = Graph.getMetrics();
            if (metrics.cycles?.count > 0) {
                document.getElementById('cycle-count').textContent =
                    `${metrics.cycles.count} cycle(s) detected`;
                document.getElementById('cycle-count').style.color = '#ff79c6';
            }
        }

        function setupUI() {
            // View mode buttons
            const viewButtons = {
                'btn-force': Graph.VIEW_MODES.FORCE,
                'btn-hierarchy': Graph.VIEW_MODES.HIERARCHY,
                'btn-radial': Graph.VIEW_MODES.RADIAL,
                'btn-cluster': Graph.VIEW_MODES.CLUSTER
            };

            Object.entries(viewButtons).forEach(([id, mode]) => {
                document.getElementById(id).addEventListener('click', () => {
                    Graph.setViewMode(mode);
                    updateViewModeUI(mode);
                });
            });

            // Filter
            document.getElementById('filter-status').addEventListener('change', (e) => {
                Graph.setFilter('status', e.target.value || null);
            });

            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                Graph.search(e.target.value);
            });

            // Highlight buttons
            document.getElementById('btn-critical').addEventListener('click', () => {
                Graph.highlightCriticalPath();
            });

            document.getElementById('btn-cycles').addEventListener('click', () => {
                Graph.highlightCycles();
            });

            // View controls
            document.getElementById('btn-fit').addEventListener('click', () => {
                Graph.zoomToFit();
            });

            document.getElementById('btn-reset').addEventListener('click', () => {
                Graph.resetView();
            });

            // Event listeners
            document.addEventListener('bv-graph:selectionChange', (e) => {
                updateNodeDetail(e.detail.node);
            });

            document.addEventListener('bv-graph:viewModeChange', (e) => {
                updateViewModeUI(e.detail.mode);
            });

            document.addEventListener('bv-graph:searchRequest', () => {
                document.getElementById('search-input').focus();
            });
        }

        function updateViewModeUI(mode) {
            // Update only view mode buttons (not other toolbar buttons)
            const viewModeButtons = ['btn-force', 'btn-hierarchy', 'btn-radial', 'btn-cluster'];
            viewModeButtons.forEach(id => {
                document.getElementById(id)?.classList.remove('active');
            });

            const modeMap = {
                'force': 'btn-force',
                'hierarchy': 'btn-hierarchy',
                'radial': 'btn-radial',
                'cluster': 'btn-cluster'
            };

            const btnId = modeMap[mode];
            if (btnId) {
                document.getElementById(btnId).classList.add('active');
            }

            // Update indicator
            document.querySelector('#view-mode span').textContent =
                mode.charAt(0).toUpperCase() + mode.slice(1);
        }

        function updateNodeDetail(node) {
            const detail = document.getElementById('node-detail');
            const noSelection = document.getElementById('no-selection');

            if (node) {
                const icons = { bug: 'üêõ', feature: '‚ú®', task: 'üìù', epic: 'üéØ', chore: 'üîß' };
                const priorityColors = ['#ff0000', '#ff5555', '#ffb86c', '#f1fa8c', '#6272a4'];

                document.getElementById('detail-icon').textContent = icons[node.type] || 'üìã';
                document.getElementById('detail-id').textContent = node.id;
                document.getElementById('detail-name').textContent = node.title;

                const statusEl = document.getElementById('detail-status');
                statusEl.textContent = node.status;
                statusEl.className = `badge badge-${node.status}`;

                document.getElementById('detail-priority').textContent = `P${node.priority}`;
                document.getElementById('detail-priority').style.color = priorityColors[node.priority];

                document.getElementById('detail-blockers').textContent = node.blockerCount;
                document.getElementById('detail-dependents').textContent = node.dependentCount;
                document.getElementById('detail-pagerank').textContent = (node.pagerank * 100).toFixed(1) + '%';
                document.getElementById('detail-depth').textContent = node.criticalDepth;

                const labelsEl = document.getElementById('detail-labels');
                labelsEl.innerHTML = (node.labels || [])
                    .map(l => `<span class="label-tag">${l}</span>`)
                    .join('');

                detail.classList.add('visible');
                noSelection.style.display = 'none';
            } else {
                detail.classList.remove('visible');
                noSelection.style.display = 'block';
            }
        }

        // Start
        init();
    </script>
</body>
</html>
